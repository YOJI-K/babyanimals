<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ニュース記事 | どうベビ</title>
  <meta name="description" content="どうベビ（動物園ベビー情報）のオリジナル記事ページです。">

  <!-- OGP（JSで上書きされます） -->
  <meta property="og:type" content="article">
  <meta property="og:title" content="ニュース記事 | どうベビ">
  <meta property="og:description" content="どうベビのオリジナル記事">
  <meta property="og:image" content="/assets/img/og.png">
  <meta property="og:url" content="">
  <link rel="icon" href="/assets/img/favicon.svg" type="image/svg+xml">

  <!-- Supabase（メタ値フォールバック） -->
  <meta name="supabase-url" content="https://hvhpfrksyytthupboaeo.supabase.co">
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2aHBmcmtzeXl0dGh1cGJvYWVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTc4MzQsImV4cCI6MjA3MjYzMzgzNH0.e5w3uSzajTHYdbtbVGDVFmQxcwe5HkyKSoVM7tMmKaY">

  <!-- 共通スタイル -->
  <link rel="stylesheet" href="/assets/css/style.css" />
  <!-- Cloudflare Web Analytics -->
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js"
    data-cf-beacon='{"token":"5b85d28b47c74f79b6ad1c1f19c0a758"}'></script>
  <!-- canonical（JSで最終URLに置き換え） -->
  <link id="canonical" rel="canonical" href="https://babyanimals.pages.dev/news/">
  <style>
    /* 記事専用の軽い追加だけ（共通デザインは style.css 依存） */
    .article-wrap{max-width:880px;margin-inline:auto;}
    .article-meta{color:#6f6166;font-size:14px;margin:10px 0 16px;}
    .article-cover{border-radius:16px;overflow:hidden;background:#fff;display:block}
    .article-cover img{width:100%;height:auto;display:block}
    .article-body{font-size:16.5px;line-height:1.9;}
    .article-body h2{font-size:22px;margin:24px 0 10px}
    .backline{display:inline-flex;align-items:center;gap:8px;margin:6px 0 18px;color:#6b3d52;text-decoration:none;font-weight:700}
    .backline::before{content:"←";}
    @media(min-width:720px){ .article-body{font-size:18px} }
  </style>
</head>
<body class="theme">
  <!-- Header（Candy × Emoji） -->
  <header class="site-header site-header--candy" role="banner">
    <div class="site-header__left">
      <a class="brand" href="/index.html" aria-label="ホームへ">
        <span class="brand__emoji" aria-hidden="true">🐾</span>
        <svg class="brand__icon" aria-hidden="true" focusable="false"><use href="/assets/icons/icons.svg#icon-logo"></use></svg>
        <span class="brand__title">どうベビ</span>
      </a>
    </div>
    <div class="site-header__right">
      <button class="pill-btn like-btn" aria-label="お気に入り"><span class="emoji-icon">💗</span></button>
      <button class="pill-btn search-btn" aria-label="検索"><span class="emoji-icon">🔍</span></button>
      <button class="pill-btn bell-btn" aria-label="お知らせ"><span class="emoji-icon">🔔</span><span class="badge">!</span></button>
    </div>
  </header>

  <!-- Tabbar（スタック型・絵文字、共通デザイン） -->
  <nav class="tabbar tabbar--stack" aria-label="メイン">
    <a class="tabbar__link" href="/index.html" title="ホーム"><span class="tab-emoji">🏠</span><span class="tabbar__text">ホーム</span></a>
    <a class="tabbar__link is-active" href="/news/index.html" aria-current="page" title="ニュース"><span class="tab-emoji">📰</span><span class="tabbar__text">ニュース</span></a>
    <a class="tabbar__link" href="/babies/index.html" title="赤ちゃん"><span class="tab-emoji">🍼</span><span class="tabbar__text">赤ちゃん</span></a>
    <a class="tabbar__link" href="/calendar/index.html" title="カレンダー"><span class="tab-emoji">📅</span><span class="tabbar__text">カレンダー</span></a>
  </nav>

  <main class="container" id="main">
    <div class="article-wrap card">
      <a href="/news/index.html" class="backline">ニュース一覧に戻る</a>
      <article id="article">
        <header>
          <h1 id="title" class="page-title">—</h1>
          <div class="article-meta"><span id="date">—</span> ｜ <span id="source">編集部</span></div>
          <figure id="cover" class="article-cover" hidden>
            <img id="cover-img" src="" alt="">
          </figure>
        </header>
        <section id="body" class="article-body">読み込み中…</section>
      </article>
    </div>
  </main>

  <footer class="site-footer" aria-label="フッター">
    <small>© どうベビ（動物園ベビー情報）</small>
  </footer>

  <!-- 共通JS（タブのactive付与などに利用） -->
  <script src="/assets/js/app.js" defer></script>

  <!-- 記事描画用JS -->
  <script>
  (function(){
    const qs = (s,ctx=document)=>ctx.querySelector(s);
    const SUPA_URL = document.querySelector('meta[name="supabase-url"]').content;
    const ANON     = document.querySelector('meta[name="supabase-anon-key"]').content;

    // slug は ?slug=xxx か /news/xxx（_redirectsで変換済み）のどちらにも対応
    function getSlug(){
      const u = new URL(location.href);
      const s = u.searchParams.get('slug');
      if (s) return s;
      // 念のため /news/xxx のまま来た時
      const m = location.pathname.match(/\/news\/([^\/?#]+)/);
      return m ? m[1] : '';
    }

    async function fetchJSON(path){
      const url = new URL(path, SUPA_URL);
      const res = await fetch(url.toString(), {
        headers:{ apikey:ANON, Authorization:`Bearer ${ANON}` },
        cache:'no-store'
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    function fmtDate(iso){
      const d = new Date(iso); if(isNaN(d)) return '';
      return d.toLocaleDateString('ja-JP', {year:'numeric', month:'long', day:'numeric'});
    }

    function setOG({title, description, image, url}){
      const set = (sel, name, val) => {
        if (!val) return;
        let el = qs(sel);
        if (!el) { el = document.createElement('meta'); el.setAttribute(name, sel.includes('property')?'property':'name'); document.head.appendChild(el); }
        el.setAttribute('content', val);
      };
      set('meta[property="og:title"]','property',title);
      set('meta[property="og:description"]','property',description);
      set('meta[property="og:image"]','property',image);
      set('meta[property="og:url"]','property',url);
      // canonical
      const can = qs('#canonical'); if (can) can.href = url;
      document.title = `${title} | どうベビ`;
    }

    async function init(){
      const slug = getSlug();
      if(!slug){ qs('#body').textContent = '記事が見つかりませんでした。'; return; }

      // 自サイト記事のみ（status=published のみ表示）
      const rows = await fetchJSON(`/rest/v1/articles?slug=eq.${encodeURIComponent(slug)}&status=eq.published&select=title,body_html,cover_url,published_at,author`);
      const a = rows?.[0];
      if(!a){ qs('#body').textContent = '記事が見つかりませんでした。'; return; }

      qs('#title').textContent = a.title || '(無題)';
      qs('#date').textContent  = a.published_at ? fmtDate(a.published_at) : '';
      qs('#source').textContent= a.author || '編集部';

      if (a.cover_url){
        qs('#cover-img').src = a.cover_url;
        qs('#cover-img').alt = a.title || '';
        qs('#cover').hidden = false;
      }

      // 安全な最小限のサニタイズ（基本は CMS 側でHTMLを生成している前提）
      qs('#body').innerHTML = a.body_html || '';

      const url = `${location.origin}/news/${slug}`;
      setOG({
        title: a.title,
        description: (qs('#body').textContent || '').trim().slice(0, 120),
        image: a.cover_url || '/assets/img/og.png',
        url
      });
    }

    init().catch(e=>{
      console.error(e);
      qs('#body').textContent = '読み込みに失敗しました。時間をおいて再度お試しください。';
    });
  })();
  </script>
</body>
</html>
