<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ニュース一覧 | Baby Animals</title>

  <!-- SEO / OGP -->
  <meta name="description" content="日本の動物園にいる赤ちゃん動物のニュースを集約。ブログ・公式サイト・YouTubeなどからまとめて一覧表示。">
  <meta property="og:type" content="website">
  <meta property="og:title" content="ニュース一覧 | Baby Animals">
  <meta property="og:description" content="日本の動物園にいる赤ちゃん動物のニュースを集約。ブログ・公式・YouTubeなどからまとめて一覧表示。">
  <meta property="og:url" content="https://babyanimals.pages.dev/news/">
  <meta property="og:image" content="https://babyanimals.pages.dev/assets/img/og.png">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="icon" href="/assets/img/favicon.svg" type="image/svg+xml">

  <!-- ▼ Supabase REST 設定（環境に合わせて差し替え） -->
  <meta name="supabase-url" content="YOUR_SUPABASE_URL">
  <meta name="supabase-anon-key" content="YOUR_SUPABASE_ANON_KEY">

  <link rel="stylesheet" href="/assets/css/style.css">
  <script defer src="/assets/js/app.js"></script>
  <script defer src="/assets/js/news.js"></script>

  <!-- 16:9固定サムネ & レイアウト -->
  <style>
    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    @media (max-width: 599px) {
      .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    }
    @media (min-width: 600px) and (max-width: 1023px) {
      .grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (min-width: 1024px) {
      .grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }

    .card {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      display: flex;
      flex-direction: column;
      transition: transform .12s ease;
    }
    .card:hover { transform: translateY(-2px); }
    .card a { color: inherit; text-decoration: none; }

    .thumb {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #f2f2f2;
      overflow: hidden;
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .pad { padding: 10px 12px 12px; }
    .title {
      font-size: 14.5px;
      line-height: 1.5;
      font-weight: 600;
      margin: 6px 0 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .meta {
      font-size: 12px;
      color: #666;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .meta .dot::before { content: "・"; margin: 0 2px; color: #aaa; }

    .controls.sticky {
      position: sticky;
      top: 0;
      background: #fff;
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      z-index: 10;
      display: grid;
      grid-template-columns: 1fr 160px 120px;
      gap: 8px;
    }
    @media (max-width: 599px) {
      .controls.sticky { grid-template-columns: 1fr 1fr; }
      .controls.sticky #sort { grid-column: span 2; }
    }

    .skeleton {
      background: linear-gradient(90deg, #eee 25%, #f7f7f7 37%, #eee 63%);
      animation: shimmer 1.35s infinite;
      background-size: 400% 100%;
    }
    @keyframes shimmer {
      0% { background-position: 100% 0; }
      100% { background-position: 0 0; }
    }
    #error {
      display: none;
      background: #fff7f7;
      border: 1px solid #ffdede;
      color: #a40000;
      padding: 10px 12px;
      border-radius: 10px;
      margin: 14px 0;
    }

    .more-wrap {
      display: flex;
      justify-content: center;
      margin: 16px 0 32px;
    }
    #more {
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
    }
    #more[disabled] { opacity: .6; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container hero">
    <h1>ニュース一覧</h1>

    <!-- 検索/絞り込み/ソート（「もっと読む」は下部に配置） -->
    <div class="controls sticky">
      <input id="q" type="search" placeholder="キーワード検索（タイトル/ソース）">
      <select id="source">
        <option value="">すべてのソース</option>
        <option value="YouTube">YouTube</option>
        <option value="blog">ブログ/ニュース</option>
      </select>
      <select id="sort">
        <option value="desc" selected>新着順</option>
        <option value="asc">古い順</option>
      </select>
    </div>

    <div class="banner">（インフィード広告枠）</div>

    <!-- スケルトン（初期表示） -->
    <div id="skeleton-news" class="grid" aria-hidden="true">
      <div class="card"><div class="thumb skeleton"></div><div class="pad"><div class="skeleton" style="height:14px;width:80%;border-radius:8px;margin:6px 0;"></div><div class="skeleton" style="height:12px;width:50%;border-radius:8px;"></div></div></div>
      <div class="card"><div class="thumb skeleton"></div><div class="pad"><div class="skeleton" style="height:14px;width:80%;border-radius:8px;margin:6px 0;"></div><div class="skeleton" style="height:12px;width:50%;border-radius:8px;"></div></div></div>
      <div class="card"><div class="thumb skeleton"></div><div class="pad"><div class="skeleton" style="height:14px;width:80%;border-radius:8px;margin:6px 0;"></div><div class="skeleton" style="height:12px;width:50%;border-radius:8px;"></div></div></div>
      <div class="card"><div class="thumb skeleton"></div><div class="pad"><div class="skeleton" style="height:14px;width:80%;border-radius:8px;margin:6px 0;"></div><div class="skeleton" style="height:12px;width:50%;border-radius:8px;"></div></div></div>
      <div class="card"><div class="thumb skeleton"></div><div class="pad"><div class="skeleton" style="height:14px;width:80%;border-radius:8px;margin:6px 0;"></div><div class="skeleton" style="height:12px;width:50%;border-radius:8px;"></div></div></div>
      <div class="card"><div class="thumb skeleton"></div><div class="pad"><div class="skeleton" style="height:14px;width:80%;border-radius:8px;margin:6px 0;"></div><div class="skeleton" style="height:12px;width:50%;border-radius:8px;"></div></div></div>
      <div class="card"><div class="thumb skeleton"></div><div class="pad"><div class="skeleton" style="height:14px;width:80%;border-radius:8px;margin:6px 0;"></div><div class="skeleton" style="height:12px;width:50%;border-radius:8px;"></div></div></div>
      <div class="card"><div class="thumb skeleton"></div><div class="pad"><div class="skeleton" style="height:14px;width:80%;border-radius:8px;margin:6px 0;"></div><div class="skeleton" style="height:12px;width:50%;border-radius:8px;"></div></div></div>
    </div>

    <div id="error"></div>

    <!-- 実データ -->
    <div id="list" class="grid" aria-live="polite"></div>

    <!-- 空状態 -->
    <div id="empty" class="empty" style="display:none;">データがありません</div>

    <!-- 下部に「もっと読む」 -->
    <div class="more-wrap">
      <button id="more">もっと読む</button>
    </div>
  </div>

  <script>
    (function () {
      // ===== パラメータ =====
      const INITIAL_COUNT = 12;  // 初期表示件数（ご要望）
      const LOAD_MORE = 12;      // 1クリックで増える件数（ご要望）
      const SERVER_PAGE_SIZE = 50; // サーバー取得単位（多少大きめに取得してクライアントで分割）

      const metaUrl = document.querySelector('meta[name="supabase-url"]')?.content?.trim();
      const metaKey = document.querySelector('meta[name="supabase-anon-key"]')?.content?.trim();
      const SUPABASE_URL = window.SUPABASE_URL || metaUrl;
      const SUPABASE_KEY = window.SUPABASE_ANON_KEY || metaKey;

      // DOM
      const $q = document.getElementById('q');
      const $source = document.getElementById('source');
      const $sort = document.getElementById('sort');
      const $list = document.getElementById('list');
      const $empty = document.getElementById('empty');
      const $skeleton = document.getElementById('skeleton-news');
      const $error = document.getElementById('error');
      const $more = document.getElementById('more');

      // 状態
      let fetched = [];        // サーバーから蓄積した生データ
      let filtered = [];       // フィルタ/ソート後の配列
      let renderedCount = 0;   // 現在表示している件数
      let serverOffset = 0;    // サーバー側 OFFSET
      let serverHasMore = true;
      let serverSort = 'desc'; // 'desc' | 'asc'
      let loading = false;

      // ===== 共通ユーティリティ =====
      function showError(msg) {
        $error.style.display = 'block';
        $error.textContent = msg;
      }

      function renderCards(items) {
        // items は「表示したい件数に切り出された filtered のスライス」
        const frag = document.createDocumentFragment();
        for (const it of items) {
          const a = document.createElement('a');
          a.href = it.url || it.source_url || '#';
          a.target = '_blank';
          a.rel = 'noopener';

          const card = document.createElement('div');
          card.className = 'card';

          const thumb = document.createElement('div');
          thumb.className = 'thumb';
          const img = document.createElement('img');
          img.loading = 'lazy';
          img.alt = it.title || '';
          img.src = it.thumbnail_url || '/assets/img/noimage-16x9.png';
          thumb.appendChild(img);

          const pad = document.createElement('div');
          pad.className = 'pad';

          const title = document.createElement('div');
          title.className = 'title';
          title.textContent = it.title || '(無題)';

          const meta = document.createElement('div');
          meta.className = 'meta';
          const d = it.published_at ? new Date(it.published_at) : null;
          const dateStr = d ? d.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }) : '';
          meta.innerHTML = `<span>${dateStr}</span><span class="dot"></span><span>${it.source_name || ''}</span>`;

          pad.appendChild(title);
          pad.appendChild(meta);

          card.appendChild(thumb);
          card.appendChild(pad);
          a.appendChild(card);
          frag.appendChild(a);
        }
        $list.innerHTML = '';
        $list.appendChild(frag);
      }

      function applyFilterAndSort({ resetRendered = true } = {}) {
        const q = ($q.value || '').trim().toLowerCase();
        const src = ($source.value || '').trim();

        // フィルタ
        filtered = fetched.filter(it => {
          const hitQ = !q || ((it.title || '').toLowerCase().includes(q) || (it.source_name || '').toLowerCase().includes(q));
          const hitS = !src || (src === 'YouTube'
            ? (it.source_name || '').toLowerCase().includes('youtube')
            : (it.source_name || '').toLowerCase().includes('blog') || (it.source_name || '').includes('ブログ') || (it.source_name || '').includes('news') || (it.source_name || '').includes('公式'));
          return hitQ && hitS;
        });

        // 並び：UI の sort 値（published_at + id）
        const dir = $sort.value === 'asc' ? 1 : -1;
        filtered.sort((a, b) => {
          const ad = new Date(a.published_at || 0).getTime();
          const bd = new Date(b.published_at || 0).getTime();
          if (ad !== bd) return (ad < bd ? -1 : 1) * dir;
          if (a.id !== b.id) return (a.id < b.id ? -1 : 1) * dir;
          return 0;
        });

        // resetRendered=true のときは初期件数に戻す（検索・ソート操作時）
        if (resetRendered) {
          renderedCount = Math.min(INITIAL_COUNT, filtered.length);
        } else {
          // resetしない場合（＝サーバーから追加入荷など）は、既存の renderedCount を維持
          renderedCount = Math.min(renderedCount, filtered.length);
        }

        renderCards(filtered.slice(0, renderedCount));
        $empty.style.display = filtered.length ? 'none' : 'block';
        toggleMoreButton();
      }

      function toggleMoreButton() {
        const clientHasMore = renderedCount < filtered.length;
        const shouldShow = clientHasMore || serverHasMore;
        $more.disabled = !shouldShow;
        $more.style.display = shouldShow ? 'inline-flex' : 'none';
      }

      // ===== イベント =====
      function debounce(fn, ms) {
        let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
      }
      $q.addEventListener('input', debounce(() => applyFilterAndSort({ resetRendered: true }), 200));
      $source.addEventListener('change', () => applyFilterAndSort({ resetRendered: true }));
      $sort.addEventListener('change', () => {
        serverSort = $sort.value === 'asc' ? 'asc' : 'desc';
        applyFilterAndSort({ resetRendered: true });
      });

      $more.addEventListener('click', async () => {
        // まずクライアント側の未描画分を追加
        if (renderedCount < filtered.length) {
          renderedCount = Math.min(renderedCount + LOAD_MORE, filtered.length);
          renderCards(filtered.slice(0, renderedCount));
          toggleMoreButton();
          return;
        }
        // クライアントが尽きていれば、サーバーからさらに取得
        if (serverHasMore && !loading) {
          const got = await fetchFromServer({ append: true });
          // 取得件数があれば、レンダリング数は +LOAD_MORE 増やして維持（初期化しない）
          if (got > 0) {
            // フィルタ・ソートは維持しつつ resetRendered=false
            applyFilterAndSort({ resetRendered: false });
            // さらにクライアント側でLOAD_MORE分増やす（新規データ分を使って拡張）
            const target = Math.min(renderedCount + LOAD_MORE, filtered.length);
            renderedCount = target;
            renderCards(filtered.slice(0, renderedCount));
            toggleMoreButton();
          } else {
            toggleMoreButton();
          }
        }
      });

      // ===== サーバー取得 =====
      async function fetchFromServer({ append } = { append: false }) {
        if (!SUPABASE_URL || !SUPABASE_KEY) {
          showError('Supabase の URL / ANON KEY が設定されていません。');
          return 0;
        }
        loading = true;
        if (!append) $skeleton.style.display = 'grid';
        let received = 0;
        try {
          const orderParam = `order=published_at.${serverSort},id.${serverSort}`;
          const rangeFrom = serverOffset;
          const rangeTo = serverOffset + SERVER_PAGE_SIZE - 1;
          const url = `${SUPABASE_URL}/rest/v1/news_items?select=id,title,url,published_at,source_name,source_url,thumbnail_url&${orderParam}`;
          const resp = await fetch(url, {
            headers: {
              apikey: SUPABASE_KEY,
              Authorization: `Bearer ${SUPABASE_KEY}`,
              Range: `${rangeFrom}-${rangeTo}`,
              'Accept-Profile': 'public',
              'Content-Profile': 'public'
            },
          });

          if (resp.status === 206 || resp.status === 200) {
            const data = await resp.json();
            if (Array.isArray(data) && data.length) {
              received = data.length;
              fetched = append ? fetched.concat(data) : data;
              serverOffset += data.length;
              if (data.length < SERVER_PAGE_SIZE) serverHasMore = false;
            } else {
              serverHasMore = false;
            }
          } else if (resp.status === 401 || resp.status === 403) {
            showError('認証エラーです。Supabase の anon key / RLS / CORS 設定をご確認ください。');
            serverHasMore = false;
          } else {
            showError(`取得に失敗しました（HTTP ${resp.status}）。`);
            serverHasMore = false;
          }
        } catch (e) {
          console.error(e);
          showError('ネットワークエラーが発生しました。');
          serverHasMore = false;
        } finally {
          $skeleton.style.display = 'none';
          loading = false;
        }
        return received;
      }

      // ===== 初期ロード =====
      (async function init() {
        await fetchFromServer({ append: false });
        // 初期表示は INITIAL_COUNT 件
        applyFilterAndSort({ resetRendered: true });
      })();
    })();
  </script>
</body>
</html>
